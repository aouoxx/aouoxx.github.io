### 实时数据体系建设的难点

​

- 实时数仓建设过程中由于其数据处理任务的常驻性，使得其在建设过程中和离线任务在设计思路上还是有些不同。实时数仓建设应该尽量的合并计算单元，降低拓扑层次，一方面减少资源的使用，另一方面过多的分层会导致数据的延迟加大降低了数据的可用性。
- 实时数仓在数据加工和离线数据还是有本质的不同，离线数据的有界性，使其在周期性调度处理数据时容易被理解和操作。而实时数仓在关联和加工复合型指标的场景下, 需要对其时间线，随着无界数据的持续输入，数据状态始终在发生变化，明细数据量大, 则 OLAP 引擎压力加大；聚合粒度高，则由于无界数据完整性带来的数据误差会加大。故需要根据实际情况在 flink 聚合与 OLAP 引擎聚合之间找到平衡点。
- 在精确性上差异，离线数据可以保证绝对的准确性，实时数据在去重指标上，会采用相关算法进行估算，理论上存在一定误差，需要管理预期。

​

### 实时数仓目前现状

由于我们电商团队实时数仓团队需求太多导致我们被迫紧赶需求，并没有太多对我们实时资产进行沉淀。导致我们出现下面一些问题。
**1 开发复杂,代码无法复用**
简单的例子, 如下在我们开发实时任务是经常出现重复定义 DDL,并且还容易导致我们复杂修改出错。
![image.png](https://cdn.nlark.com/yuque/0/2022/png/659846/1646104078272-59908850-3480-4c78-9653-1b6cb9e52d8e.png#clientId=ue406156c-45d4-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=309&id=ua0e3027b&margin=%5Bobject%20Object%5D&name=image.png&originHeight=2324&originWidth=5204&originalType=binary&ratio=1&rotation=0&showTitle=false&size=2214240&status=done&style=none&taskId=u03bf3ef1-a3ed-451a-bbdf-50a4691bc55&title=&width=692)

我们如上面的例子我们很难完成数据内容的复用，频繁的定义 DDL，有时可很可能出现由于 DDL 的拷贝，或实际内容的裁剪导致我们很难进行统一管理某个流表具体的使用内容，为后续数据的治理和变更，埋下一个地雷。
​

**2 运维复杂**
我们比较难知道某个数据的上下游链路。并且我们也能知道我们对某一数据的变更会影响我们下游哪些任务和业务。
​

**3 数据价值无法描述**
我们目前无法知道我们实时数仓哪些资产是核心，或是只能知道业务方确切使用的一些指标，但对这些指标构建流程不清楚。也无法量化我们当前实时数仓的表热度，从而无法明确我们实时数仓建设的好坏
​

### 实时数据内容建设收益

​

- 成体系构建实时数仓内容，明确我们目前有哪些资产，以及我们核心资产是什么。
- 业务方能够快速检索我们的资产内容，能够在我们的资产的基础上做简单灵活的资产重组和优化。
- 标准化管理我们资产内容，保障我们资产的稳定性，及时性。
- 实时数据内容建设也便于后续推动 流-湖-仓的一体化进程。

​

​

### 迭代式的推进开发方案

​

#### 实时资产的落地方式

![image.png](https://cdn.nlark.com/yuque/0/2022/png/659846/1646308498121-09bca05e-3a6b-43a0-84e5-b6191cc30e15.png#clientId=u2209659b-13d6-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=446&id=ucdf47437&margin=%5Bobject%20Object%5D&name=image.png&originHeight=892&originWidth=2356&originalType=binary&ratio=1&rotation=0&showTitle=false&size=154072&status=done&style=none&taskId=u92344136-749a-41e8-88a3-643f588f344&title=&width=1178)
​

​

​

#### 可能遇到的问题和解法

** ods 层**

1. 业务方为了敏捷开发和快速交付 可能存在多个相同数据的 topic, 导致数仓 ods 层表过多冗余的问题 2) ods 层数据纵表的问题 - 先搁置争议 3) ods 数据质量管理- 实时数据 DQC 包括数据量监控 + 数据合规 + 枚举值 + 空置判断 + CEP 自定义的规则 4) ods 层的数据分发 ---> 所有的 binlog 接入到同一个 topic 然后由 tag 进行分发
   如果没有分发机制 会导致 某个 topic 的压力增加---形成 IO 的瓶颈

​

​

​

​

```
实时基础层的建设要解决一些问题。首先是一条流重复读的问题, 一条Binlog打过来, 是以DB包的形式存在的，用户可能只用其中一张表，如果大家都要用，可能存在所有人都要接这个流的问题。
解决方案是可以按照不同的业务解构出来，还原到基础数据流层，根据业务需要做成范式结构，按照数仓的建模方式进行集成化的主题建设。
```

​

​

​

​

实时数据仓库 本身就是一个宽表形式的存在，任何一个字段的增减都是因为对业务重要的影响才会去加，都要经过技术评估，尽可能的避免冗余字段。为什么不能存在冗余字段，因为我们宽表都一些大宽表，我们一般都是 150~200 多个左右。
​

实时数据仓库分层，有轻度汇总层，在流量很高的业务中，中间层 DWS 层就是大家非常敏感的，有时可能是非必要的，并且这一层很多时候偏向分析，主要原因在于中间的轻度汇总层的精确性比较难保证（统计量比较难以保持精确）关联 flink 的 retract stream
​

双流 join 的问题，
Q1: 双流 JOIN, FLink 原生的 Internal Join 中 State 的大小，TTL24 小时， flink 任务重启之后，state 对么，state 是否可以确保对么。还有一些场景 TTL 要大于 30D，大家如何解决的 ?
Q2: 业务方把主子订单的所有的数据在日志发送时全部关联上。
​

查询服务
Q1 字段级别的鉴权。SQL 路由。
Q1 实时数仓能不能多表 Join 可能会和维度表 join，绝不能 业务主题域的数据 Join
Q2 OLAP 的 TTL 的设置多少，和离线数据仓库数据比对，对数的情况是怎样的。
Q3 严格报警功能，实时任务比离线任务难 100 倍
严格的报警功能，完善的监控大盘，紧急情况的处理。
​

​

指标体系
原子指标
度量
频率
​

​

事实表的设计
相对维度，增长快，状态变化频繁
每一个业务动作事件，都可以作为一个事实，比如下单，付款，发货
包含外键，关联相关维度
包含度量值 (业务方使用人员索要关心的指标)
完全可加
半可加
不可加比如，订单完成率，翻台率，CTR, CVR 等
数据降维 (利用数据冗余来达到降维的目的，提高任务的执行效率)
​

​

业务过程
一个行为动词，在业务执行的过程中一般都有一个动词的行为意义。
粒度
总得来说就是业务中在何处何时为什么如何的背景下，完成了一个什么样的事。 1) 用维度组合表示的细节程度，一般寻找业务过程的最细维度。
​

​

实时数仓目前还没有一套非常完美的类似离线的数仓体系建设的行业标准
​

​

​

由于历史问题，数据仓库体系建设比较混乱，无规范，无意识的烟筒式构建玩法。所谓的敏捷开发。
这个问题在于我们经常倍琐粹的业务，琐粹的分析，琐碎的取数，占用了很多大量的时间。 我们需要沉淀一下，我们为什么要这样做，为什么要这样做，为什么要定义。做业务，我们为什么要做留存，做渠道，做活跃
​

​

从埋点 ( 不规范 )，埋点有多个数据来源，无法完成统一的数据收口，不同的同学使用不用的表数据。导致做出的数据五花八门，比如我们在说车辆开锁的这个数据的时候，既有前段埋点，又有业务埋点
​

​

​

业务都可以使用 OSM 模型来定义

```
 Object O目标:
 		用户来用使用这个产品, 目标是什么
 Strategy S 策略:
 		为了达成上述目标我采取了哪些策略
 Measurement 度量
 	  采取的策略带来哪些数据指标变化

```

​

​

​

```
对于电商类产品, GMV 很重要, 意味着在平台成交的金额大小。
对于视频类产品, 那么关键指标是观看时长
对于广告平台产品, 消耗很重要, 如何提升广告主转化效果, 贡献的广告ecmp更高
```

​

​

​

​

​

![image.png](https://cdn.nlark.com/yuque/0/2022/png/659846/1646305366165-6e0492f5-b1a4-42e5-a172-b0f9522ca6bd.png#clientId=u2209659b-13d6-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=119&id=u8927bcc4&margin=%5Bobject%20Object%5D&name=image.png&originHeight=238&originWidth=1290&originalType=binary&ratio=1&rotation=0&showTitle=false&size=44522&status=done&style=none&taskId=u875d73ce-70fd-4392-ac6c-4782b799167&title=&width=645)()

![image.png](https://cdn.nlark.com/yuque/0/2022/png/659846/1646308249541-f7bda643-be91-4fd6-b8ae-770c04839ee9.png#clientId=u2209659b-13d6-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=339&id=u6b32468d&margin=%5Bobject%20Object%5D&name=image.png&originHeight=678&originWidth=1250&originalType=binary&ratio=1&rotation=0&showTitle=false&size=92865&status=done&style=none&taskId=uf31d1743-49af-41f8-822c-10d820281a2&title=&width=625)
